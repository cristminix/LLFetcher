var A=Object.defineProperty;var j=(u,n,e)=>n in u?A(u,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[n]=e;var r=(u,n,e)=>(j(u,typeof n!="symbol"?n+"":n,e),e);import{r as T,c as N,j as o,a as P,A as k,C as R,B as F,S as U,b as B,R as I}from"./font-awesome.min-pPzmwAtt.js";import{s as O,a as $}from"./index-l-FjSNo0.js";class x extends T.Component{constructor(){super(...arguments);r(this,"commandListener",(e,t)=>{this.onMessageCommand(e,t)})}async sendMessageAsync(e,t,s="content"){return new Promise((a,c)=>{const i=(l,C)=>{chrome.runtime.onMessage.removeListener(i),a([l,C])};try{chrome.runtime.onMessage.addListener(i),O(e,t,s)}catch(l){c(l)}})}async getFromMessage(e,t,s){const[a,c]=await this.sendMessageAsync(e,t,s);return a.name===e?a.data:null}async onMessageCommand(e,t){}onMessage(){try{chrome.runtime.onMessage.removeListener(this.commandListener),chrome.runtime.onMessage.addListener(this.commandListener)}catch(e){console.log(e)}}initMessaging(){this.onMessage()}}class D extends x{constructor(e){super(e);r(this,"mApp",null);r(this,"mCourse",null);r(this,"mAuthor",null);r(this,"mSection",null);r(this,"mToc",null);r(this,"store",null);r(this,"courseAuthors",[]);const{store:t}=e;this.store=t,this.mApp=t.get("App"),this.mCourse=t.get("Course"),this.mAuthor=t.get("Author"),this.mSection=t.get("Section"),this.mToc=t.get("Toc"),this.mPrxCache=t.get("PrxCache"),this.state={greeting:"LLFetcher 3.0+",lastCourseList:{},fetchBtnState:0,loading:!1,courseInfo:null,validCoursePage:!1,disableFetchBtn:!1,isLogin:!1,legacyMode:!1,blockMainContent:!1}}async addToLastCourseList(e){this.setState({courseInfo:e});const t=e.slug,s=await this.createCourse(e);Object.keys(this.state.lastCourseList).includes(t)||this.populateLastCourseList(),await this.props.onSelectCourse(s,this.courseAuthors)}onMessageCommand(e,t){e.name==="cmd.validCoursePageAuto"&&this.setState({validCoursePage:e.data})}populateLastCourseList(){const e=this.mCourse.getList();let t={};for(let s in e)t[e[s].slug]=e[s];this.setState({lastCourseList:t})}async componentDidMount(){this.populateLastCourseList(),this.initMessaging(),await this.getValidCourseMessage()}async getValidCourseMessage(){const e="cmd.validCoursePage",t=await this.getFromMessage(e);this.setState({validCoursePage:t})}async insertCourseLegacyM3Rec(e,t){await this.mPrxCache.set(e,t,200),await this.activateAddCourseOptionTab(e,!0)}async insertCourseLegacy(e,t){if(e){const{title:s,slug:a,duration:c,sourceCodeRepository:i,description:l,urn:C}=e,p=await this.mCourse.create(s,a,c,i,l,C);if(p){console.log(p);const y=p.id;if(Array.isArray(t))for(const g of t){const f=[],d=$(g.title),h=await this.mSection.create(g.title,d,y,f);if(h){if(console.log(h),Array.isArray(g.items))for(const m of g.items){const b=h.id,M=null,v=null,w=N(`${e.slug}/${m.slug}`),S=await this.mToc.create(m.title,m.slug,w,m.duration,null,null,b,M,v);S?console.log(S):console.error("failed to create toc")}}else console.error("failed to create section")}}else console.error("failed to create course")}}async addCourseLegacy(e){this.setState({blockMainContent:!0});const t="cmd.getM3Rec",s=await this.getFromMessage(t,e);this.insertCourseLegacyM3Rec(e,s),this.setState({blockMainContent:!1})}async getIsLoginMessage(){const e="cmd.isLogin",t=await this.getFromMessage(e);this.seState({isLogin:t})}async getCourseInfoMessage(){const e="cmd.getCourseInfo";this.setState({fetchBtnState:1});const t=await this.getFromMessage(e);await this.addToLastCourseList(t)}async getCurrentTabUrl(){return new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},function(s){let c=s[0].url;e(c)})})}async activateAddCourseOptionTab(e,t=!1){const s="src/option-pages/",a=chrome.runtime.getURL(`${s}options.html`),c=`${a}#/course/add/${e}?useM3Rec=${t?1:0}`;(await chrome.tabs.query({url:`${a}*`})).length>0?chrome.runtime.sendMessage({action:"activateTab",url:c,optionPageBaseUrl:s}):chrome.tabs.create({url:c})}async addCourseFromCurrentUrl(){const t=(await this.getCurrentTabUrl()).replace("https://www.linkedin.com/learning/","").split("/")[0],{legacyMode:s}=this.state;s?this.addCourseLegacy(t):this.activateAddCourseOptionTab(t)}async onSelectCourse(e){this.activateAddCourseOptionTab(e)}onLegacyModeChanged(e){this.setState({legacyMode:e})}render(){const{blockMainContent:e,legacyMode:t,isLogin:s,greeting:a,lastCourseList:c,fetchBtnState:i,validCoursePage:l,loading:C,disableFetchBtn:p}=this.state,y=Object.keys(c),g=i==0?"fa-plus":i==1?"fa-spin fa-spinner":i==2?"fa-refresh":"fa-hand-o-right",f=y.map(d=>{const h=c[d],m=h.slug,b=h.title;return{value:m,text:b}});return o.jsxs("div",{className:"relative",children:[e?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"absolute top-0 start-0 w-full h-full bg-white/[.5] rounded-lg dark:bg-gray-800/[.4]"}),o.jsx("div",{className:"absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2",children:o.jsx("div",{className:"animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full dark:text-blue-500",role:"status","aria-label":"loading",children:o.jsx("span",{className:"sr-only",children:"Loading..."})})})]}):null,o.jsxs("div",{className:"welcome-page page gap-2 flex flex-col items-center pt-2",children:[o.jsxs("div",{className:"flex gap-2",children:[o.jsx("div",{children:o.jsx("img",{src:P})}),o.jsx("div",{children:o.jsx("p",{className:"font-bold pt-2 pb-4 text-center text-lg",style:{fontFamily:"Monoton, cursive"},children:a})})]}),o.jsxs("div",{className:"action-cnt w-full",children:[f.length>0?o.jsx(o.Fragment,{children:o.jsx(k,{data:f,label:"Load Last Course",onSelect:d=>this.onSelectCourse(d)})}):"",l?o.jsxs("div",{className:"btn-cnt text-center flex gap-2 p-2",children:[o.jsx(R,{label:"Legacy Mode",className:"pt-2",checked:t,onChange:d=>this.onLegacyModeChanged(d)}),o.jsx(F,{disabled:i==1||!l||p,className:"mx-auto btn btn-primary",onClick:d=>this.addCourseFromCurrentUrl(),icon:`fa ${g}`,caption:"Add This Course"})]}):""]})]})]})}}class q extends x{constructor(e){super(e);r(this,"store",null);r(this,"mApp",null);r(this,"mAuthor",null);r(this,"mSection",null);r(this,"mToc",null);r(this,"mCourse",null);const{store:t}=e;this.store=t,this.mApp=t.get("App"),this.mAuthor=t.get("Author"),this.mSection=t.get("Section"),this.mToc=t.get("Toc"),this.mCourse=t.get("Course"),this.state={course:null,courseAuthors:null,courseSectionInfoStr:"[]",courseSectionStr:"[]",courseTocsStr:"[]",nav:"welcome"}}onNavUpdate(e){this.setState({nav:e})}async loadCourseSections(){if(console.log("Popup.createCourseSections() empty csi "),console.log("try to load from database "),this.state.course){const e=this.mSection.getList(this.state.course.id);let t={};for(let s in e){const a=e[s];t[a.slug]=this.mToc.getListBySectionId(a.id)}await this.updateCourseData(e,t)}}async activateOptionTab(e){const t=chrome.runtime.getURL(`options.html#/manager/${e}`);(await chrome.tabs.query({url:`${chrome.runtime.getURL("options.html")}*`})).length>0?chrome.runtime.sendMessage({action:"activateTab",url:t}):chrome.tabs.create({url:t}),setTimeout(a=>window.close(),100)}async updateCourseData(e,t){const s=JSON.stringify(e),a=JSON.stringify(t);this.setState({courseSectionStr:s,courseTocsStr:a},async()=>{this.state.course.slug!==""&&(await this.mCourse.setLastSlug(this.state.course.slug),this.setState({nav:"course"},()=>{const{course:c,sections:i,tocs:l}=this.state;console.log(c,i,l)}),this.activateOptionTab(this.state.course.slug))})}}class E extends q{constructor(n){super(n)}async onSelectCourse(n){console.log(n)}componentDidMount(){}render(){const{store:n}=this;return o.jsx("div",{className:"app-container w-[300px] py-4 px-2 dark:bg-gray-700 dark:text-gray-200",children:o.jsx(D,{store:n})})}}const L=U.getInstance();L.ready(()=>{B.createRoot(document.getElementById("popup")).render(o.jsx(I.StrictMode,{children:o.jsx(E,{store:L})}))});
